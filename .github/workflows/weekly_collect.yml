name: Weekly News Collection

on:
  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 8ì‹œ KST (= UTC 23:00 ì¼ìš”ì¼) ì‹¤í–‰
  schedule:
    - cron: '0 23 * * 0'  # UTC 23:00 ì¼ìš”ì¼ = KST 08:00 ì›”ìš”ì¼
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸŒ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
    
    - name: ğŸ“° ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤í–‰
      run: |
        python -c "from processors.pipeline import run_ds_news_pipeline; import logging; logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'); stats = run_ds_news_pipeline(); print(f'\n===== ìˆ˜ì§‘ ì™„ë£Œ ====='); print(f'ìˆ˜ì§‘: {stats[\"original_articles\"]}ê°œ â†’ í•„í„°ë§: {stats[\"filtered_articles\"]}ê°œ â†’ ë²ˆì—­: {stats[\"translated_articles\"]}ê°œ â†’ ìš”ì•½: {stats[\"summarized_articles\"]}ê°œ â†’ ì €ì¥: {stats[\"final_articles\"]}ê°œ'); print(f'ì†Œìš”ì‹œê°„: {stats.get(\"total_duration_str\", \"N/A\")}')"
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: ğŸ“Š ê²°ê³¼ í™•ì¸
      run: |
        if [ -f "data/articles.json" ]; then
          echo "âœ… ìˆ˜ì§‘ ì™„ë£Œ!"
          ARTICLE_COUNT=$(python -c "import json; data=json.load(open('data/articles.json')); print(len(data.get('articles', [])))")
          echo "ìˆ˜ì§‘ëœ ê¸€ ê°œìˆ˜: $ARTICLE_COUNT"
        else
          echo "âŒ articles.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
    
    - name: ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # ë‚ ì§œë³„ íˆìŠ¤í† ë¦¬ íŒŒì¼ë§Œ ì¶”ê°€ (articles_YYYY-MM-DD.json)
        git add data/articles_*.json 2>/dev/null || echo "ë‚ ì§œë³„ íŒŒì¼ ì—†ìŒ"
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          CURRENT_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
          git commit -m "ğŸ“° ì£¼ê°„ ìë™ ìˆ˜ì§‘: $CURRENT_DATE"
          git push
          echo "âœ… ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
        fi
    
    - name: ğŸ“‹ ìˆ˜ì§‘ í†µê³„
      if: always()
      run: |
        echo "=== ìˆ˜ì§‘ í†µê³„ ==="
        if [ -f "data/articles.json" ]; then
          ARTICLE_COUNT=$(python -c "import json; data=json.load(open('data/articles.json')); print(len(data.get('articles', [])))")
          COLLECT_DATE=$(python -c "import json; data=json.load(open('data/articles.json')); print(data.get('date', 'N/A'))")
          echo "ğŸ“Š ì´ ê¸€ ê°œìˆ˜: $ARTICLE_COUNT"
          echo "ğŸ“… ìˆ˜ì§‘ ë‚ ì§œ: $COLLECT_DATE"
        else
          echo "âŒ ìˆ˜ì§‘ íŒŒì¼ ì—†ìŒ"
        fi

