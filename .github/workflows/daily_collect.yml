name: Weekly News Collection

on:
  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 8ì‹œ KST (= UTC 23:00 ì¼ìš”ì¼) ì‹¤í–‰
  schedule:
    - cron: '0 23 * * 0'  # UTC 23:00 ì¼ìš”ì¼ = KST 08:00 ì›”ìš”ì¼
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸŒ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
    
    - name: ğŸ“° ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤í–‰
      run: |
        python main.py
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: ğŸ“Š ê²°ê³¼ í™•ì¸
      run: |
        if [ -f "data/articles.json" ]; then
          echo "âœ… ìˆ˜ì§‘ ì™„ë£Œ!"
          ARTICLE_COUNT=$(python -c "import json; data=json.load(open('data/articles.json')); print(len(data.get('articles', [])))")
          echo "ìˆ˜ì§‘ëœ ê¸€ ê°œìˆ˜: $ARTICLE_COUNT"
        else
          echo "âŒ articles.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
    
    - name: ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # data ë””ë ‰í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ë§Œ ì¶”ê°€
        git add data/articles*.json
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          CURRENT_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
          git commit -m "ğŸ“° ìë™ ìˆ˜ì§‘: $CURRENT_DATE"
          git push
          echo "âœ… ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
        fi
    
    - name: ğŸ“‹ ìˆ˜ì§‘ í†µê³„
      if: always()
      run: |
        echo "=== ìˆ˜ì§‘ í†µê³„ ==="
        if [ -f "data/articles.json" ]; then
          python -c "
import json
from datetime import datetime

with open('data/articles.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
    
articles = data.get('articles', [])
print(f'ğŸ“Š ì´ ê¸€ ê°œìˆ˜: {len(articles)}')
print(f'ğŸ“… ìˆ˜ì§‘ ë‚ ì§œ: {data.get(\"date\", \"N/A\")}')

# ì†ŒìŠ¤ë³„ í†µê³„
sources = {}
for article in articles:
    source = article.get('source', 'unknown')
    sources[source] = sources.get(source, 0) + 1

print('\\nğŸ“° ì†ŒìŠ¤ë³„ ë¶„í¬:')
for source, count in sorted(sources.items(), key=lambda x: x[1], reverse=True):
    print(f'  - {source}: {count}ê°œ')
"
        else
          echo "âŒ ìˆ˜ì§‘ íŒŒì¼ ì—†ìŒ"
        fi

